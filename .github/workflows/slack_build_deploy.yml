name: Slack build and delpoy notification

on:
  workflow_call:
    inputs:
      message_ts:
        required: false
        type: string
      app_name:
        required: true
        type: string
      target_name:
        required: true
        type: string
      status:
        required: true
        type: string
      version:
        required: true
        type: string
      build_number:
        required: true
        type: string
      changelog:
        required: false
        type: string

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
    - name: Prepare statuses
      id: statuses
      run: |
        read -r -d '' JSON << EOF
        {
            "building": {
                "status": "ðŸ•‘ *Buildingâ€¦*",
                "color": null
            },
            "deploying": {
                "status": "ðŸ•ž *Deployingâ€¦*",
                "color": null
            },
            "success": {
                "status": "ðŸŸ¢ *Built and deployed*",
                "color": "green"
            },
            "build_error": {
                "status": "ðŸ”´ *Building error*",
                "color": "red"
            },
            "deploy_error": {
                "status": "ðŸ”´ *Deploying error*",
                "color": "red"
            }
        }
        EOF
        echo "JSON=$(echo $JSON)" >> $GITHUB_OUTPUT 
    - id: slack
      uses: slackapi/slack-github-action@v1.23.0
      with:
       channel-id: ${{ env.slack_channel }}
       payload: |
        {
            "text": "${{ inputs.app_name }} â†’ ${{ inputs.target_name }}",
            "blocks": [
                {
                    "type": "header",
                    "text": {
                        "type": "plain_text",
                        "text": "${{ inputs.app_name }} â†’ ${{ inputs.target_name }}",
                        "emoji": true
                    }
                },
                {
                    "type": "context",
                    "elements": [
                        {
                            "type": "mrkdwn",
                            "text": "${{ fromJSON(steps.statuses.outputs.JSON).${{ inputs.status }} }}"
                        }
                    ]
                },
                {
                    "type": "section",
                    "fields": [
                        {
                            "type": "mrkdwn",
                            "text": "*Version:*\n${{ inputs.version }}"
                        },
                        {
                            "type": "mrkdwn",
                            "text": "*Build number:*\n${{ inputs.build_number }}"
                        }
                    ]
                },
                {
                    "type": "section",
                    "fields": [
                        {
                            "type": "mrkdwn",
                            "text": "*Branch:*\n${{ github.ref_name }}"
                        },
                        {
                            "type": "mrkdwn",
                            "text": "*Started by:*\n${{ github.actor }}"
                        }
                    ]
                },
                {
                    "type": "section",
                    "text": {
                        "type": "mrkdwn",
                        "text": "*Changelog:*\n${{ inputs.app_name }}"
                    }
                },
                {
                    "type": "section",
                    "text": {
                        "type": "mrkdwn",
                        "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View this action on GitHub>"
                    }
                }
            ]
        }
    env:
     SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN}}
